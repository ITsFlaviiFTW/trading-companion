{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-2">
  <div>
    <h4 class="mb-0">{{ run.strategy.name }}</h4>
    <div class="small-muted">
      Started {{ run.started_at|date:"Y-m-d H:i" }}
      {% if run.symbol %}| {{ run.symbol }}{% endif %}
      | Progress {{ checked_steps }}/{{ total_steps }}
    </div>
  </div>
  <a class="btn btn-outline-dark btn-sm" href="{% url 'dashboard' %}">Dashboard</a>
</div>

<form method="post">
  {% csrf_token %}
  {% for row in section_rows %}
    <div class="card p-3 mb-3">
      <h5 class="mb-2">{{ row.section.name }}</h5>
      {% for step_row in row.steps %}
        <div class="border rounded p-2 mb-2">
          <div class="d-flex justify-content-between align-items-start gap-2">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="step_{{ step_row.step.id }}" name="step_{{ step_row.step.id }}_checked" {% if step_row.check and step_row.check.checked %}checked{% endif %}>
              <label class="form-check-label" for="step_{{ step_row.step.id }}">
                <strong>{{ step_row.step.title }}</strong>
                {% if step_row.step.required %}<span class="badge bg-dark ms-1">Required</span>{% endif %}
              </label>
            </div>
            {% if step_row.has_images %}
              <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#examples_{{ step_row.step.id }}">
                View examples
              </button>
            {% endif %}
          </div>

          {% if step_row.step.description %}
            <div class="small-muted mt-1">{{ step_row.step.description }}</div>
          {% endif %}
          {% if step_row.check and step_row.check.checked_at %}
            <div class="small-muted mt-1">Checked at {{ step_row.check.checked_at|date:"H:i:s" }}</div>
          {% endif %}
          <div class="mt-2">
            <input class="form-control form-control-sm" type="text" name="step_{{ step_row.step.id }}_notes" value="{% if step_row.check %}{{ step_row.check.notes }}{% endif %}" placeholder="Quick note">
          </div>

          {% if step_row.has_images %}
            <div class="collapse mt-2" id="examples_{{ step_row.step.id }}">
              <div class="row g-2">
                {% for img in step_row.images %}
                  <div class="col-12 col-md-6">
                    <div class="border rounded p-2 h-100">
                      <img class="img-fluid step-image-thumb d-block mb-2" src="{{ img.image.url }}" alt="{{ img.caption|default:step_row.step.title }}">
                      {% if img.caption %}
                        <div class="small-muted">{{ img.caption }}</div>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        </div>
      {% empty %}
        <div class="small-muted">No steps in this section yet.</div>
      {% endfor %}
    </div>
  {% endfor %}

  <div class="d-flex gap-2 mb-3">
    <button class="btn btn-outline-dark" type="submit">Save Progress</button>
    <button class="btn btn-dark" type="submit" name="go_review" value="1">Go To Review</button>
  </div>
</form>
{% endblock %}
